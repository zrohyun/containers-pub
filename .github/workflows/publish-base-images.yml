name: publish-base-images

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"
  push:
    branches:
      - main
    paths:
      - .github/workflows/publish-base-images.yml
      - docker/packages/apt-common.txt
      - docker/ubuntu-apt/Dockerfile
      - docker/ubuntu-brew/Dockerfile
      - docker/ubuntu-apt-brew/Dockerfile

permissions:
  contents: read
  packages: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      date_tag: ${{ steps.meta.outputs.date_tag }}
      owner_lc: ${{ steps.meta.outputs.owner_lc }}
      build_apt: ${{ steps.plan.outputs.build_apt }}
      build_brew: ${{ steps.plan.outputs.build_brew }}
      build_apt_brew: ${{ steps.plan.outputs.build_apt_brew }}
      apt_brew_base_tag: ${{ steps.plan.outputs.apt_brew_base_tag }}
    steps:
      - uses: actions/checkout@v4

      - id: meta
        run: |
          echo "date_tag=$(date -u +%Y%m%d)" >> "$GITHUB_OUTPUT"
          echo "owner_lc=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - id: changed
        if: github.event_name == 'push'
        uses: dorny/paths-filter@v3
        with:
          filters: |
            apt:
              - 'docker/ubuntu-apt/Dockerfile'
              - 'docker/packages/apt-common.txt'
            brew:
              - 'docker/ubuntu-brew/Dockerfile'
            apt_brew:
              - 'docker/ubuntu-apt-brew/Dockerfile'
            workflow:
              - '.github/workflows/publish-base-images.yml'

      - id: plan
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            BUILD_APT=true
            BUILD_BREW=true
            BUILD_APT_BREW=true
            APT_BREW_BASE_TAG="24.04-${{ steps.meta.outputs.date_tag }}"
          else
            CHANGED_APT="${{ steps.changed.outputs.apt || 'false' }}"
            CHANGED_BREW="${{ steps.changed.outputs.brew || 'false' }}"
            CHANGED_APT_BREW="${{ steps.changed.outputs.apt_brew || 'false' }}"
            CHANGED_WORKFLOW="${{ steps.changed.outputs.workflow || 'false' }}"

            if [ "$CHANGED_APT" = "true" ] || [ "$CHANGED_WORKFLOW" = "true" ]; then
              BUILD_APT=true
            else
              BUILD_APT=false
            fi

            if [ "$CHANGED_BREW" = "true" ] || [ "$CHANGED_WORKFLOW" = "true" ]; then
              BUILD_BREW=true
            else
              BUILD_BREW=false
            fi

            if [ "$CHANGED_APT_BREW" = "true" ] || [ "$CHANGED_WORKFLOW" = "true" ] || [ "$BUILD_APT" = "true" ]; then
              BUILD_APT_BREW=true
            else
              BUILD_APT_BREW=false
            fi

            if [ "$BUILD_APT" = "true" ]; then
              APT_BREW_BASE_TAG="24.04-${{ steps.meta.outputs.date_tag }}"
            else
              APT_BREW_BASE_TAG="24.04"
            fi
          fi

          echo "build_apt=$BUILD_APT" >> "$GITHUB_OUTPUT"
          echo "build_brew=$BUILD_BREW" >> "$GITHUB_OUTPUT"
          echo "build_apt_brew=$BUILD_APT_BREW" >> "$GITHUB_OUTPUT"
          echo "apt_brew_base_tag=$APT_BREW_BASE_TAG" >> "$GITHUB_OUTPUT"

  ubuntu-apt:
    needs: prepare
    if: needs.prepare.outputs.build_apt == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/ubuntu-apt/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ needs.prepare.outputs.owner_lc }}/base-ubuntu-apt:24.04
            ghcr.io/${{ needs.prepare.outputs.owner_lc }}/base-ubuntu-apt:24.04-${{ needs.prepare.outputs.date_tag }}

  ubuntu-brew:
    needs: prepare
    if: needs.prepare.outputs.build_brew == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/ubuntu-brew/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ needs.prepare.outputs.owner_lc }}/base-ubuntu-brew:24.04
            ghcr.io/${{ needs.prepare.outputs.owner_lc }}/base-ubuntu-brew:24.04-${{ needs.prepare.outputs.date_tag }}

  ubuntu-apt-brew:
    needs: [prepare, ubuntu-apt]
    if: needs.prepare.outputs.build_apt_brew == 'true' && (needs.prepare.outputs.build_apt != 'true' || needs.ubuntu-apt.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/ubuntu-apt-brew/Dockerfile
          push: true
          build-args: |
            IMAGE_OWNER=${{ needs.prepare.outputs.owner_lc }}
            BASE_TAG=${{ needs.prepare.outputs.apt_brew_base_tag }}
          tags: |
            ghcr.io/${{ needs.prepare.outputs.owner_lc }}/base-ubuntu-apt-brew:24.04
            ghcr.io/${{ needs.prepare.outputs.owner_lc }}/base-ubuntu-apt-brew:24.04-${{ needs.prepare.outputs.date_tag }}
